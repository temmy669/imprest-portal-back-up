name: Deploy to Production Server

on:
  push:
    branches: [ feature/response ]
    # branches: [ main, feature/response ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 159.198.36.136 >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no root@159.198.36.136 '
          cd /var/www/fcimprestportal || exit 1

          # Initialize git repo if it doesn'\''t exist
          if [ ! -d .git ]; then
            git init
            git remote add origin git@github.com:${{ github.repository }}.git
          fi

          # Pull latest changes
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}

          # Activate virtual environment and install dependencies
          source venv/bin/activate

          # Create requirements.txt if it doesn'\''t exist
          if [ ! -f requirements.txt ]; then
            echo "django>=5.2,<6.0" > requirements.txt
            echo "gunicorn>=20.0" >> requirements.txt
            echo "celery>=5.0" >> requirements.txt
            echo "redis>=4.0" >> requirements.txt
          fi

          pip install -r requirements.txt

          # Use our custom restart script for migrations, static files, and service restarts
          restart_app

          echo "ğŸ‰ Deployment completed successfully!"
        '

    - name: Health check
      run: |
        echo "Waiting for services to start..."
        sleep 10

        # Check if server is responding
        if curl -f -s -o /dev/null http://159.198.36.136; then
          echo "âœ… Server is responding"
        else
          echo "âŒ Server health check failed - but deployment may still be successful"
          echo "Check server manually: ssh root@159.198.36.136"
        fi